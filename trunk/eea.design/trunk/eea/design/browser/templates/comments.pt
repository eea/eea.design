<tal:block define="userHasReplyPermission view/can_reply;
                   isDiscussionAllowed view/is_discussion_allowed;
                   replies view/get_replies;
                   isAnon view/is_anonymous;
                   plone_view context/@@plone;
                   template_id options/template_id | template/getId | nothing;
                   view_template_id plone_view/getViewTemplateId;
                   isViewTemplate context/@@plone_context_state/is_view_template;"
                   i18n:domain="eea"
                   tal:condition="isViewTemplate">

    <!-- Comments anchor -->
    <h2 id="eea-comments" tal:condition="python:isDiscussionAllowed or not isAnon">Comments</h2>

    <!-- Top portal message -->
    <script type="text/javascript"
            tal:condition="python:isDiscussionAllowed"
            tal:content="structure string://<!--
jQuery(document).ready(function() {
  addPortalMessage();
});

function addPortalMessage() {
  context = jQuery('#region-content').children(':first');
  message = jQuery('<p>This item is open for comments. See the comments <a href=\'${context/absolute_url}#eea-comments\'>section below</a></p>');
  message.addClass('portalMessage');
  context.before(message);
};
       //-->
"></script>

    <!-- Log in for comments -->
    <tal:login define="pss modules/Products/PythonScripts/standard"
               condition="python:isAnon and isDiscussionAllowed">
        <div id="login-for-comments" class="standardButton">
            <a href="login_form" title="Log in with your Eionet password to see/add comments"
               tal:attributes="href python:'%s/login_form?came_from=%s' %
                                           (here.portal_url(),
                                           pss.url_quote(request['URL'] + '#eea-comments'))"
               i18n:attributes="title label_login_to_add_comments"
               i18n:translate="">Log in with your Eionet password to see/add comments</a>
        </div>
    </tal:login>


    <div class="discussion"
             tal:condition="python:userHasReplyPermission">

        <form name="reply"
              action=""
              method="post"
              tal:condition="python:userHasReplyPermission and isDiscussionAllowed"
              tal:attributes="action string:${context/absolute_url}/discussion_reply_form">

              <input class="standalone"
                     style="margin-bottom: 1.25em;"
                     type="submit"
                     value="Add new comment"
                     i18n:attributes="value label_add_comment;"
                     />

        </form>

            <tal:noreplies condition="not:replies">
                <p i18n:translate="">No comments.</p>
            </tal:noreplies>

        <tal:getreplies repeat="reply_dict replies">
            <div class="comment" style=""
                tal:define="indent python:reply_dict['depth']*2;
                            reply python:reply_dict['object']"
                tal:attributes="style string:margin-left:${indent}em;">

                <a name="comments" tal:attributes="name reply/id"></a>
                <div class="documentByLine"
                     tal:define="creator reply/Creator;
                                 anonymous_creator python:creator in ('Anonymous User', '');
                                 mi python:not anonymous_creator and view.member_info(creator);
                                 fullname python: mi and mi['fullname'] or creator;" >
                        <tal:name content="fullname"
                                  condition="not:anonymous_creator">Poster Name</tal:name>
                        <tal:name i18n:translate="label_anonymous_user"
                                  condition="anonymous_creator">Anonymous User</tal:name>
                    <span class="commentTime" tal:content="python:view.format_time(reply.ModificationDate())">
                        8/23/2001 12:40:44 PM
                    </span>

                </div>

                <div class="commentBody">
                    <!-- <h3 tal:content="reply/pretty_title_or_id">
                        Comment title
                    </h3> -->
                     <div tal:replace="structure reply/CookedBody">
                     This is the body text of the comment.
                     </div>

                    <div class="formControls">
                    <form name="reply"
                          action="discussion_reply_form"
                          method="post"
                          style="display: inline;"
                          tal:attributes="action string:${reply/absolute_url}/discussion_reply_form"
                          tal:condition="python:userHasReplyPermission and isDiscussionAllowed">
                        <input type="hidden"
                               name="subject"
                               tal:attributes="value reply/pretty_title_or_id" />
                        <input class="standalone"
                               type="submit"
                               value="Reply to this comment"
                               i18n:attributes="value label_reply;"
                               />
                    </form>
                    <form name="delete"
                          action=""
                          method="post"
                          style="display: inline;"
                          tal:condition="view/can_manage"
                          tal:attributes="action string:${reply/absolute_url}/deleteDiscussion">
                        <input class="destructive"
                               type="submit"
                               value="Remove"
                               i18n:attributes="value label_remove;"
                               />
                    </form>
                    </div>
                </div>
            </div>
        </tal:getreplies>
    </div>
</tal:block>
